

<!DOCTYPE html>
<html>
<script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="UTF-8">
<style>
@media (prefers-color-scheme: dark) {
    body {
        background-color: #1c1c1c;
        color: white;
    }
    .markdown-body table tr {
        background-color: #1c1c1c;
    }
    .markdown-body table tr:nth-child(2n) {
        background-color: black;
    }
}
</style>



<link rel="alternate" type="application/rss+xml" href="../../../../feed.xml" title="Ãœber Kollusion">



<link rel="stylesheet" type="text/css" href="../../../../css/common-vendor.b8ecfc406ac0b5f77a26.css">
<link rel="stylesheet" type="text/css" href="../../../../css/fretboard.f32f2a8d5293869f0195.css">
<link rel="stylesheet" type="text/css" href="../../../../css/pretty.0ae3265014f89d9850bf.css">
<link rel="stylesheet" type="text/css" href="../../../../css/pretty-vendor.83ac49e057c3eac4fce3.css">
<link rel="stylesheet" type="text/css" href="../../../../css/global.css">
<link rel="stylesheet" type="text/css" href="../../../../css/misc.css">

<script type="text/x-mathjax-config">
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\(', '\)']]
  },
  svg: {
    fontCache: 'global',
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async
  src="../../../../scripts/tex-svg.js">
</script>
<script async src="https://platform.twitter.com/widgets.js" loading="lazy" charset="utf-8"></script> 

<style>
  .twitter-tweet {
    align-items: center;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 0 auto;
}

</style>

<div id="doc" class="container-fluid markdown-body comment-enabled" data-hard-breaks="true">

<div id="color-mode-switch">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
  </svg>
  <input type="checkbox" id="switch" />
  <label for="switch">Dark Mode Toggle</label>
  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
  </svg>
</div>

<script type="text/javascript">
  
  const toggleDarkMode = () => {
    const root = document.querySelector('html');
    root.classList.toggle('dark');
  }

  
  const toggleColorScheme = () => {
    const colorScheme = localStorage.getItem('colorScheme');
    if (colorScheme === 'light') localStorage.setItem('colorScheme', 'dark');
    else localStorage.setItem('colorScheme', 'light');
  }

  
  const toggle = document.querySelector('#color-mode-switch input[type="checkbox"]');
  if (toggle) toggle.onclick = () => {
    toggleDarkMode();
    toggleColorScheme();
  }

  
  const checkColorScheme = () => {
    const colorScheme = localStorage.getItem('colorScheme');
    
    if (colorScheme === null || colorScheme === undefined) localStorage.setItem('colorScheme', 'light');
    
    if (colorScheme === 'dark') {
      toggle.checked = true;
      toggleDarkMode();
    }
  }
  checkColorScheme();
</script>

<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Analysing a state-sponsored APT29 malware" />
<br>
<h1 style="margin-bottom:7px">Analysing a state-sponsored APT29 malware</h1>
<small style="float:left; color: #888">2024 Dec 4 </small>
<small style="float:right; color: #888"><a href="../../../../index.html">See all posts</a></small>
<br><br><br>
<title>Analysing a state-sponsored APT29 malware</title>
<blockquote>
<p>Note: I am still working on this post since my initial analysis is still a work in progress.</p>
</blockquote>
<p>As how often I do, I stumbled upon a very interesting malware sample on <a href="https://bazaar.abuse.ch">abuse.ch</a>. I usually just look for malware samples from high-profilic threat-actors and advanced persistent threats (APT). The sample was first ever seen on 5th of December 2024 on 21:05:31 UTC. So this sample is brand new and has never ever been seen in this form. Possibly this is the first analysis for this variant.</p>
<p><img src="/sample.png" alt="alt"></p>
<p>After taking a closer look to the sample, I figured out, that it is a new malware sample originating from the prevalent advanced threat actor called NOBELIUM. NOBELIUM is also known under the names YTTERBIUM, MIDNIGHT BLIZZARD and APT29. You might also know it as Cozy Bear. NOBELIUM is also apparently one of worlds most sophisticated and dangerous threat actor, beeing nation/state-backed by Russia. Also I want to point out, that NOBELIUM is believed to be directly a part of the Russian government.</p>
<p>I then quickly downloaded the sample down to my detonation chamber. The initial sample is a HTML5 file with a JS script block. The JS script that is embedded in the HTML file is roughly 21k lines of code and somewhat obfuscated. What I see right at first glance, is that 20k lines are just for a single variable definition. Some kind of hashed/obfuscated string or maybe a binary string.</p>
<p><img src="/string.png" alt="alt"></p>
<p>After searching the script for the referenced variable that has been created, I figured out, that this is a XOR&rsquo;ed base64 string that will then be decrypted and loaded into another variable. As we can see in the picture below, the value of that variable will be de-XOR&rsquo;ed and then decrypted. Deeper in the code, we see that the decrypted string is then used to instanciate a new Blob with type <code>application/x-cd-image</code> and then save it to the filesystem.</p>
<p><img src="/revscript.png" alt="alt"></p>
<p>Furthermore, the script tries to retrieve the victims browseragent alongside the IP address and exact geolocation. It exfiltrates this data to an external server hosted on firebase using a JSON encoded REST-API. This data will be most likely used for statistics and to get a precise information of who the victims are.</p>
<p><img src="/exfiltration.png" alt="alt"></p>
<p>The technique of loading arbitrary binary data to the victims filesystem is called <em>HTML Smuggling</em>. It has been around for quite some time, but in my opinion it is quite cool to see some profilic APTs such as NOBELIUM still use it as a stealth delivery method.</p>
<p>The next obvious step that we need to take is to analyze and break-open the .ISO file. One Way we could do this is to mount the ISO directly into my detonation chamber into the Linux FS. The other way would be to analyze its content using <strong>isoinfo</strong> or <strong>7z</strong>. I have decided myself for the latter, so we can also analyze potentially hidden artifacts. For this I have ran the following code:</p>
<pre tabindex="0"><code>$ 7z x empty.iso -o./iso-output
</code></pre><p>This created a folder called iso-output alongside its extractions which I could to see are the following three files:</p>
<ul>
<li><strong>information.txt.lnk</strong>: A Windows shortcut file containing a command to load a DLL file into memory using rundll32.exe</li>
<li><strong>/data/mstu.dll</strong>: A hidden malicious DLL that will be loaded by the .LNK file and rundll32.exe</li>
<li><strong>/data/information.txt</strong>: Another hidden and empty plaintext file. Most likely it is just a decoy.</li>
</ul>
<p>The .ISO file is meant to be directly executed/mounted by the victim. When mounting the .ISO file, it will automatically execute the <strong>information.txt.lnk</strong> file which will load <strong>mstu.dll</strong>.</p>
<p>Alright, we know now  what the .ISO file does as well as what the shortcut file and the decoy file do. Lets move on to the main binary which is <strong>mstu.dll</strong>. I am a big fan of using <a href="https://hex-rays.com/ida-pro">IDA-Pro 7.7</a> by Hex-Rays in order to decompile and analyse binaries. It is very easy to use and super dope when generating C/C++ pseudocode. As for this case, I have used the 32bit version of it since, I was analysing a <strong>PE32 executable (DLL) (GUI) for Intel 80386</strong>.</p>
<p>Within IDA-Pro I quickly identified the only external modules that are imported into the program beeing:</p>
<ul>
<li><strong>KERNEL32.DLL</strong> and <strong>USER32.DLL</strong>: both DLLs are used to instanciate windows internal syscalls.</li>
</ul>
<p>I could then verify that <strong>/data/information.txt</strong> was a decoy file that will be opened with nodepad.exe during the main program routine.</p>
<p><img src="/decoy.png" alt="alt"></p>
<p>So we can get a better and more precise view on whats going on, I have dumped the source code alongside all referenced modules and external functions into my detonation chamber so I could play with them theme. I should also mention that the malicious mstu.dll was written using the <strong>Windows Visual C++</strong> compiler and was compiled on <em>31st of December 2023</em> which shows that this sample has been in development for over a year.</p>
<p>To follow&hellip;</p>
<h2 id="indicators-of-compromise-ioc">Indicators of compromise (IoC)</h2>
<p>Please find below the most important signatures and IoCs in <strong>YARA</strong> format.</p>
<ul>
<li><strong>SHA256</strong>: dcf48223af8bb423a0b6d4a366163b9308e9102764f0e188318a53f18d6abd25</li>
<li><strong>SHA384</strong>: 8b941c7a9814a26528fa8353c24e776f2e1a9055ecb1b43da4edf4882e8553197aae2db5e48a204cc6dcc8317cebb174</li>
<li><strong>Threat Actor</strong>: <strong>APT29</strong>/Cozy Bear/NOBELIUM</li>
<li><strong>YARA</strong>: TODO</li>
</ul>

</div>